<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Energy Dashboard Demo</title>
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Simple skeleton shimmer for loading states (if needed later) */
    .skeleton { position: relative; overflow: hidden; }
    .skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent);
      animation: shimmer 1.5s infinite; }
    @keyframes shimmer { 100% { transform: translateX(100%); } }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Recharts -->
  <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <!-- Day.js for quick date utils -->
  <script crossorigin src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
  <!-- Babel so we can write JSX inline for a single‑file GitHub Pages demo -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useMemo, useState } = React;
    const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

    // --- Dummy dataset ---
    // Monthly totals by utility / site / building for 2024 & 2025 (truncated example)
    const RAW = [
      // site CITY, bldg 109 General Library
      ...[1,2,3,4,5,6,7].map((m) => ({ year: 2024, month: m, utility: 'Electricity [kWh]', site: 'CITY', building: '109 General Library', value: 65000 + m * 1500 })),
      // 2025
      ...[1,2,3,4,5,6,7].map((m) => ({ year: 2025, month: m, utility: 'Electricity [kWh]', site: 'CITY', building: '109 General Library', value: 100000 + m * 5000 - (m===2?5000:0) + (m===4?2000:0) })),

      // Add a second building to show filter behavior
      ...[1,2,3,4,5,6,7].map((m) => ({ year: 2025, month: m, utility: 'Electricity [kWh]', site: 'CITY', building: '302 Science Centre', value: 75000 + m * 4500 })),

      // Other utilities
      ...[1,2,3,4,5,6,7].map((m) => ({ year: 2025, month: m, utility: 'Gas [MJ]', site: 'CITY', building: '109 General Library', value: 420000 + m * 12000 })),
      ...[1,2,3,4,5,6,7].map((m) => ({ year: 2025, month: m, utility: 'Water [kL]', site: 'CITY', building: '109 General Library', value: 900 + m * 20 })),
    ];

    // Simple FTE lookup per year (dummy)
    const FTE = { 2024: 12450, 2025: 12540 };

    // Utility palette for KPI badges
    const kBadge = {
      'up': 'bg-rose-100 text-rose-700',
      'down': 'bg-emerald-100 text-emerald-700'
    };

    function numberFmt(x) {
      if (x === 0) return '0';
      if (Math.abs(x) >= 1000) return x.toLocaleString();
      return x.toString();
    }

    function pctDelta(curr, prev) {
      if (!prev || prev === 0) return 0;
      return ((curr - prev) / prev) * 100;
    }

    function Header({ asOf }) {
      return (
        <div className="w-full bg-slate-900 text-white">
          <div className="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <img src="https://upload.wikimedia.org/wikipedia/commons/7/7a/University_of_Auckland_logo.svg" alt="UoA logo" className="h-8"/>
              <div className="hidden sm:block font-medium">Energy Dashboard Demo</div>
            </div>
            <div className="text-sm opacity-80">Data as at: {asOf}</div>
          </div>
        </div>
      );
    }

    function Select({ label, value, onChange, options, className }) {
      return (
        <label className={`flex items-center gap-2 ${className||''}`}>
          <span className="text-sm text-slate-600 w-24">{label}</span>
          <select value={value} onChange={(e)=>onChange(e.target.value)} className="min-w-[12rem] rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:outline-none">
            {options.map(opt => (
              <option key={opt} value={opt}>{opt}</option>
            ))}
          </select>
        </label>
      );
    }

    function Toggle({ label, value, onChange, options }) {
      return (
        <label className="flex items-center gap-2">
          <span className="text-sm text-slate-600 w-24">{label}</span>
          <div className="flex rounded-xl overflow-hidden border border-slate-300">
            {options.map(opt => (
              <button key={opt} onClick={()=>onChange(opt)} className={`px-3 py-2 text-sm ${value===opt? 'bg-slate-900 text-white' : 'bg-white text-slate-800'}`}>{opt}</button>
            ))}
          </div>
        </label>
      );
    }

    function KpiCard({ title, value, prev, suffix='' }) {
      const delta = pctDelta(value, prev);
      const trend = delta >= 0 ? 'up' : 'down';
      return (
        <div className="rounded-2xl bg-white p-5 shadow-sm ring-1 ring-slate-200">
          <div className="text-slate-500 text-sm">{title}</div>
          <div className="mt-2 text-3xl font-semibold">{numberFmt(Math.round(value))}{suffix}</div>
          <div className="mt-2 text-xs text-slate-500">Previous Year: {numberFmt(Math.round(prev||0))}{suffix}</div>
          <div className={`mt-3 inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs ${kBadge[trend]}`}>
            {delta>=0? '+':''}{delta.toFixed(1)}%
          </div>
        </div>
      );
    }

    function Panel() {
      const asOf = dayjs().format('M/D/YYYY H:mm:ss');

      // --- Controls
      const utilities = ['Electricity [kWh]', 'Gas [MJ]', 'Water [kL]'];
      const sites = ['CITY'];
      const buildings = ['109 General Library', '302 Science Centre'];
      const years = ['2024','2025'];

      const [utility, setUtility] = useState(utilities[0]);
      const [site, setSite] = useState(sites[0]);
      const [building, setBuilding] = useState(buildings[0]);
      const [comparison, setComparison] = useState('To‑Today');
      const [year, setYear] = useState('2025');

      const filtered = useMemo(() => RAW.filter(r => r.utility===utility && r.site===site && r.building===building && String(r.year)===year), [utility, site, building, year]);

      const currentTotal = useMemo(() => filtered.reduce((a,b)=>a+b.value, 0), [filtered]);

      const prevYear = String(parseInt(year) - 1);
      const prevFiltered = useMemo(() => RAW.filter(r => r.utility===utility && r.site===site && r.building===building && String(r.year)===prevYear), [utility, site, building, year]);
      const prevTotal = useMemo(() => prevFiltered.reduce((a,b)=>a+b.value, 0), [prevFiltered]);

      // Simple per‑FTE (uses year FTE lookup)
      const currentPerFte = currentTotal / (FTE[year] || 1);
      const prevPerFte = (prevTotal) / (FTE[prevYear] || 1);

      // Chart data: months 01–12 (only 1–7 filled in our dummy)
      const months = Array.from({length:12}, (_,i)=>i+1);
      const chartData = months.map(m => {
        const row = filtered.find(x => x.month===m);
        return { mm: String(m).padStart(2,'0'), value: row ? row.value : 0 };
      });

      return (
        <div className="min-h-screen">
          <Header asOf={asOf} />

          {/* Filters */}
          <div className="mx-auto max-w-7xl px-4 py-5">
            <div className="flex flex-wrap gap-4 items-center">
              <Select label="Utility:" value={utility} onChange={setUtility} options={utilities} />
              <Select label="Site Label:" value={site} onChange={setSite} options={sites} />
              <Select label="Building" value={building} onChange={setBuilding} options={buildings} />
              <Toggle label="Comparison" value={comparison} onChange={setComparison} options={["To‑Today","Prev Year"]} />
              <Select label="Year" value={year} onChange={setYear} options={years} />
              <button className="ml-auto rounded-xl bg-slate-200 px-3 py-2 text-xs" title="Data Glossary">Data Glossary ℹ️</button>
            </div>
          </div>

          {/* Content */}
          <div className="mx-auto max-w-7xl px-4 pb-12 grid grid-cols-1 lg:grid-cols-12 gap-6">
            {/* Left: KPIs */}
            <div className="lg:col-span-4 space-y-6">
              <h2 className="text-xl font-semibold">Total Consumption</h2>
              <KpiCard title={utility} value={currentTotal} prev={prevTotal} />
              <KpiCard title={`${utility} per FTE`} value={currentPerFte} prev={prevPerFte} />
              <div className="rounded-2xl border border-dashed border-slate-300 p-6 text-slate-500 text-center">
                More metrics coming soon!
              </div>
              <div className="rounded-2xl border border-dashed border-slate-300 p-6 text-slate-500 text-center">
                More metrics coming soon!
              </div>
            </div>

            {/* Right: Chart */}
            <div className="lg:col-span-8">
              <div className="rounded-2xl bg-white p-5 shadow-sm ring-1 ring-slate-200">
                <div className="text-lg font-semibold">{utility.replace(/\s*\[[^\]]+\]/,'')} Consumption by Building</div>
                <div className="text-sm text-slate-500 mt-1">{utility}</div>
                <div className="mt-4 h-[360px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={chartData} margin={{ top: 10, right: 20, left: 0, bottom: 10 }}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="mm" label={{ value: 'Year | Mm', position: 'insideBottom', offset: -5 }} />
                      <YAxis tickFormatter={(v)=>numberFmt(v)} />
                      <Tooltip formatter={(v)=>numberFmt(Math.round(v))} />
                      <Bar dataKey="value" radius={[8,8,0,0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-2 text-xs text-slate-500">Showing {building} — {site} — {year}</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function App(){ return <Panel /> }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
